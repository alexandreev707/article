<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layouts/layout}">
<head>
    <title>Favorites - Marketplace</title>
</head>
<body>
<div th:fragment="content">
    <div class="container py-8">
        <h1 class="text-3xl font-bold mb-8 text-gray-900">❤️ Favorites</h1>

        <div id="favoritesContainer" class="product-grid">
            <div class="text-center py-12 col-span-full">
                <div class="spinner"></div>
                <p class="text-gray-500 mt-4">Loading favorites...</p>
            </div>
        </div>

        <div id="pagination" class="mt-8 flex justify-center items-center gap-4 hidden">
            <button id="prevPage" class="btn-secondary px-6 py-2">← Previous</button>
            <span id="pageInfo" class="text-gray-600 font-medium">Page 1 of 1</span>
            <button id="nextPage" class="btn-secondary px-6 py-2">Next →</button>
        </div>
    </div>

    <script>
        let currentPage = 0;
        const pageSize = 12;

        async function loadFavorites() {
            try {
                const response = await fetch(`/api/favorites?page=${currentPage}&size=${pageSize}`);
                const data = await response.json();

                console.log('❤️ Favorites:', data);

                const container = document.getElementById('favoritesContainer');
                const pagination = document.getElementById('pagination');

                const products = data.products || [];
                const totalPages = data.totalPages || 1;

                if (products.length === 0) {
                    container.innerHTML = `
                    <div class="col-span-full text-center py-16 text-gray-500">
                        <div class="text-6xl mb-4">❤️</div>
                        <p class="text-xl mb-2">Favorites are empty</p>
                        <p class="text-lg">Add products by clicking ❤️ on the product page</p>
                    </div>
                `;
                    if (pagination) pagination.classList.add('hidden');
                    return;
                }

                container.innerHTML = products.map(product => `
                <div class="product-card" style="display: flex; flex-direction: column;">
                    <a href="/products/${product.id}" class="block flex-1" style="text-decoration: none; color: inherit;">
                        <div class="product-card-image">
                            <img src="${(product.images && product.images[0]) ? product.images[0] : '/images/placeholder.png'}"
                                 alt="${(product.title || '').replace(/"/g, '&quot;')}"
                                 onerror="this.src='/images/placeholder.png'; this.onerror=null;">
                            <div class="product-card-badge" style="left: 8px; right: auto; background: #EF4444;">❤️ Favorite</div>
                        </div>
                        <div class="product-card-content">
                            <h3 class="product-card-title">${escapeHtml(product.title || '')}</h3>
                            <div class="mt-auto">
                                <div class="product-card-price">$${Number(product.price || 0).toFixed(2)}</div>
                                ${product.category ? '<div class="text-gray-500 text-xs mb-1">' + escapeHtml(product.category) + '</div>' : ''}
                                <div class="product-card-rating">
                                    <span class="product-card-rating-star">★</span>
                                    <span>${Number(product.rating || 0).toFixed(1)}</span>
                                    <span class="text-gray-400 ml-1">(${product.reviewCount || 0})</span>
                                </div>
                                ${product.stock != null ? '<div class="text-xs text-gray-500 mt-1">In stock: ' + product.stock + '</div>' : ''}
                            </div>
                        </div>
                    </a>
                    <div class="p-4 pt-0 flex gap-2 flex-wrap">
                        <button type="button" onclick="addToCartFromFavorites('${product.id}')" class="product-card-add-cart flex-1" style="margin-top: 0;">Add to cart</button>
                        <button type="button" onclick="removeFromFavorites('${product.id}')" class="bg-red-50 text-red-600 hover:bg-red-100 py-2 px-3 text-sm rounded-lg border border-red-200">Remove</button>
                    </div>
                </div>
            `).join('');

                if (pagination) {
                    document.getElementById('pageInfo').textContent =
                        `Page ${currentPage + 1} of ${totalPages}`;

                    document.getElementById('prevPage').disabled = currentPage === 0;
                    document.getElementById('nextPage').disabled = currentPage >= totalPages - 1;
                    pagination.classList.remove('hidden');
                }

            } catch (error) {
                console.error('❌ Favorites error:', error);
                document.getElementById('favoritesContainer').innerHTML =
                    '<p class="text-center py-12 text-red-500">Failed to load favorites</p>';
            }
        }

        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        async function removeFromFavorites(productId) {
            try {
                await fetch(`/api/favorites/${productId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || '' }
                });
                showToast('Removed from favorites', 'success');
                loadFavorites();
            } catch (error) {
                showToast('Remove failed', 'error');
            }
        }

        async function addToCartFromFavorites(productId) {
            try {
                const res = await fetch('/api/cart/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.content || '' },
                    body: JSON.stringify({ productId: String(productId), quantity: 1 })
                });
                if (!res.ok) throw new Error(await res.text());
                showToast('Added to cart', 'success');
            } catch (e) {
                showToast(e.message || 'Failed', 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-20 right-4 z-50 px-6 py-4 rounded-xl shadow-2xl text-white font-semibold max-w-sm
            ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadFavorites();

            document.getElementById('prevPage')?.addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    loadFavorites();
                }
            });

            document.getElementById('nextPage')?.addEventListener('click', () => {
                currentPage++;
                loadFavorites();
            });
        });
    </script>
</div>
</body>
</html>
